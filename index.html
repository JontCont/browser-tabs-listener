<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç€è¦½å™¨åˆ†é ç›£è½å™¨</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” ç€è¦½å™¨åˆ†é ç›£è½å™¨</h1>
            <p>æª¢æ¸¬åˆ†é ç‹€æ…‹è®ŠåŒ–ã€æ–°åˆ†é é–‹å•Ÿå’Œé‡è¤‡åˆ†é </p>
        </header>

        <main>
            <!-- åˆ†é ç‹€æ…‹é¡¯ç¤º -->
            <section class="status-panel">
                <h2>ğŸ“Š ç•¶å‰ç‹€æ…‹</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="label">åˆ†é ç‹€æ…‹:</span>
                        <span id="tab-status" class="value">æ´»èº</span>
                    </div>
                    <div class="status-item">
                        <span class="label">å¯è¦‹æ€§:</span>
                        <span id="visibility-status" class="value">å¯è¦‹</span>
                    </div>
                    <div class="status-item">
                        <span class="label">é–‹å•Ÿæ–¹å¼:</span>
                        <span id="opener-status" class="value">æª¢æ¸¬ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span class="label">é‡è¤‡åˆ†é :</span>
                        <span id="duplicate-status" class="value">æª¢æ¸¬ä¸­...</span>
                    </div>
                </div>
            </section>

            <!-- çµ±è¨ˆè³‡è¨Š -->
            <section class="stats-panel">
                <h2>ğŸ“ˆ çµ±è¨ˆè³‡è¨Š</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="focus-changes">0</div>
                        <div class="stat-label">ç„¦é»è®ŠåŒ–æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="visibility-changes">0</div>
                        <div class="stat-label">å¯è¦‹æ€§è®ŠåŒ–æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="active-time">0</div>
                        <div class="stat-label">æ´»èºæ™‚é–“ (ç§’)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-time">0</div>
                        <div class="stat-label">ç¸½åœç•™æ™‚é–“ (ç§’)</div>
                    </div>
                </div>
            </section>

            <!-- äº‹ä»¶æ—¥èªŒ -->
            <section class="log-panel">
                <h2>ğŸ“ äº‹ä»¶æ—¥èªŒ</h2>
                <div class="log-controls">
                    <button id="clear-log">æ¸…é™¤æ—¥èªŒ</button>
                    <button id="export-log">åŒ¯å‡ºæ—¥èªŒ</button>
                </div>
                <div id="event-log" class="log-container">
                    <!-- äº‹ä»¶æ—¥èªŒå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </section>

            <!-- æ¸¬è©¦å€åŸŸ -->
            <section class="test-panel">
                <h2>ğŸ§ª æ¸¬è©¦åŠŸèƒ½</h2>
                <div class="test-buttons">
                    <button onclick="openNewTab()">åœ¨æ–°åˆ†é é–‹å•Ÿç•¶å‰é é¢</button>
                    <button onclick="triggerFocusChange()">æ¨¡æ“¬ç„¦é»è®ŠåŒ–</button>
                    <button onclick="showPageInfo()">é¡¯ç¤ºé é¢è³‡è¨Š</button>
                    <button onclick="showTabInfo()">é¡¯ç¤ºåˆ†é æª¢æ¸¬è³‡è¨Š</button>
                    <button onclick="resetStats()">é‡ç½®çµ±è¨ˆ</button>
                </div>
                <div id="test-output" class="test-output">
                    <!-- æ¸¬è©¦è¼¸å‡ºå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 ç€è¦½å™¨åˆ†é ç›£è½å™¨ - ç´”ç¶²é ç«¯å¯¦ç¾</p>
        </footer>
    </div>

    <!-- JavaScript æª”æ¡ˆ -->
    <script src="js/utils.js"></script>
    <script src="js/duplicate-detector.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/tab-listener.js"></script>

    <script>
        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        window.addEventListener('DOMContentLoaded', () => {
            initTabListener();
            initDuplicateDetector();
            initStats();
            
            // è¨˜éŒ„é é¢è¼‰å…¥äº‹ä»¶
            logEvent('é é¢å·²è¼‰å…¥', 'info');
        });

        // æ¸¬è©¦åŠŸèƒ½
        function openNewTab() {
            const url = window.location.href;
            window.open(url, '_blank');
            logEvent('åœ¨æ–°åˆ†é é–‹å•Ÿç•¶å‰é é¢', 'action');
        }

        function triggerFocusChange() {
            // æ¨¡æ“¬ç„¦é»è®ŠåŒ–ï¼ˆåƒ…ä¾›æ¼”ç¤ºï¼‰
            window.blur();
            setTimeout(() => window.focus(), 1000);
            logEvent('æ¨¡æ“¬ç„¦é»è®ŠåŒ–', 'action');
        }

        function showPageInfo() {
            const info = {
                'URL': window.location.href,
                'Referrer': document.referrer || 'ç„¡',
                'User Agent': navigator.userAgent,
                'Screen Resolution': `${screen.width}x${screen.height}`,
                'Viewport Size': `${window.innerWidth}x${window.innerHeight}`
            };
            
            let output = '<h3>é é¢è³‡è¨Š:</h3><ul>';
            for (const [key, value] of Object.entries(info)) {
                output += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            output += '</ul>';
            
            document.getElementById('test-output').innerHTML = output;
            logEvent('é¡¯ç¤ºé é¢è³‡è¨Š', 'action');
        }

        function showTabInfo() {
            if (duplicateDetector) {
                const tabInfo = duplicateDetector.getTabInfo();
                
                let output = '<h3>åˆ†é æª¢æ¸¬è³‡è¨Š:</h3><ul>';
                output += `<li><strong>åˆ†é  ID:</strong> ${tabInfo.tabId}</li>`;
                output += `<li><strong>æ˜¯å¦é‡è¤‡åˆ†é :</strong> ${tabInfo.isDuplicate ? 'æ˜¯' : 'å¦'}</li>`;
                output += `<li><strong>æ˜¯å¦åŸå§‹åˆ†é :</strong> ${tabInfo.isOriginalTab ? 'æ˜¯' : 'å¦'}</li>`;
                output += `<li><strong>ç›¸åŒ URL åˆ†é æ•¸:</strong> ${tabInfo.sameUrlTabs}</li>`;
                output += `<li><strong>ç¸½åˆ†é æ•¸:</strong> ${tabInfo.tabCount}</li>`;
                output += `<li><strong>æ´»èºå¯¦ä¾‹æ•¸:</strong> ${tabInfo.activeInstances}</li>`;
                output += `<li><strong>æœƒè©± ID:</strong> ${tabInfo.sessionId}</li>`;
                output += `<li><strong>Broadcast Channel æ”¯æ´:</strong> ${tabInfo.broadcastSupported ? 'æ˜¯' : 'å¦'}</li>`;
                
                if (tabInfo.instances.length > 0) {
                    output += '<li><strong>æ´»èºåˆ†é åˆ—è¡¨:</strong><ul>';
                    tabInfo.instances.forEach(instance => {
                        const openTime = new Date(instance.openedAt).toLocaleTimeString();
                        const lastSeen = new Date(instance.lastSeen).toLocaleTimeString();
                        const isCurrent = instance.isCurrentTab ? ' (ç•¶å‰åˆ†é )' : '';
                        output += `<li>ID: ${instance.tabId.substring(0, 8)}... - é–‹å•Ÿ: ${openTime} - æœ€å¾Œæ´»å‹•: ${lastSeen}${isCurrent}</li>`;
                    });
                    output += '</ul></li>';
                }
                
                output += '</ul>';
                
                document.getElementById('test-output').innerHTML = output;
                logEvent('é¡¯ç¤ºåˆ†é æª¢æ¸¬è³‡è¨Š', 'action');
            } else {
                document.getElementById('test-output').innerHTML = '<p>åˆ†é æª¢æ¸¬å™¨å°šæœªåˆå§‹åŒ–</p>';
            }
        }

        function resetStats() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰çµ±è¨ˆè³‡æ–™å—ï¼Ÿ')) {
                resetAllStats();
                document.getElementById('event-log').innerHTML = '';
                document.getElementById('test-output').innerHTML = '';
                logEvent('çµ±è¨ˆè³‡æ–™å·²é‡ç½®', 'action');
            }
        }
    </script>
</body>
</html>
